@page "/heatpump/history"
@inject HeatPumpApiClient Api
@rendermode InteractiveServer

<PageTitle>Heat Pump ‚Äì History</PageTitle>

<h1>üìä Historic Analysis</h1>
<p class="text-muted">Compare different time ranges to see if settings changes made a positive difference.</p>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (string.IsNullOrEmpty(euid))
{
    <div class="alert alert-warning">No device set up. Go to the <a href="/heatpump">Dashboard</a> to run setup.</div>
}
else
{
    <!-- Grouping Info Panel -->
    <div class="card mb-3 border-info">
        <div class="card-header bg-info bg-opacity-10">
            <strong>‚ÑπÔ∏è About Grouping (Data Granularity)</strong>
        </div>
        <div class="card-body py-2">
            <p class="mb-1 small">The <strong>Grouping</strong> setting controls how large each time bucket is in the chart ‚Äî i.e. how finely the data is split up:</p>
            <ul class="mb-0 small">
                <li><strong>Live</strong> ‚Äî Minute-by-minute data. Select at most <strong>1 hour</strong>.</li>
                <li><strong>Day</strong> ‚Äî Hour-by-hour data. Select at most <strong>2 days</strong>.</li>
                <li><strong>Week</strong> ‚Äî Day-by-day data. Select at most <strong>14 days</strong>.</li>
                <li><strong>Month</strong> ‚Äî Day-by-day data. Select at most <strong>60 days</strong>.</li>
                <li><strong>Year</strong> ‚Äî Day-by-day data. Select at most <strong>13 months</strong>.</li>
            </ul>
        </div>
    </div>

    <!-- Date Range Controls -->
    <div class="card">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">From</label>
                    <input @bind="fromDate" type="datetime-local" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">To</label>
                    <input @bind="toDate" type="datetime-local" class="form-control form-control-sm" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Grouping</label>
                    <select @bind="grouping" class="form-select form-select-sm">
                        <option value="">Auto</option>
                        <option value="LIVE">Live (min-by-min, max 1 hr)</option>
                        <option value="DAY">Day (hour-by-hour, max 2 days)</option>
                        <option value="WEEK">Week (day-by-day, max 14 days)</option>
                        <option value="MONTH">Month (day-by-day, max 60 days)</option>
                        <option value="YEAR">Year (day-by-day, max 13 months)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary btn-sm w-100" @onclick="LoadTimeSeries" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Load Data")
                    </button>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quick Range</label>
                    <div class="btn-group btn-group-sm w-100">
                        <button class="btn btn-outline-secondary" @onclick="() => SetRange(1)">1 Day</button>
                        <button class="btn btn-outline-secondary" @onclick="() => SetRange(7)">7 Days</button>
                        <button class="btn btn-outline-secondary" @onclick="() => SetRange(30)">30 Days</button>
                        <button class="btn btn-outline-secondary" @onclick="() => SetRange(90)">90 Days</button>
                        <button class="btn btn-outline-secondary" @onclick="() => SetRange(365)">1 Year</button>
                    </div>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(rangeValidationMessage))
            {
                <div class="alert alert-warning mt-2 mb-0 py-1 small">‚ö†Ô∏è @rangeValidationMessage</div>
            }
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        var alertClass = statusMessage.Contains("‚úÖ") ? "alert-success"
            : statusMessage.Contains("‚ùå") ? "alert-danger" : "alert-info";
        <div class="alert @alertClass mt-3">@statusMessage</div>
    }

    @if (timeSeriesData.Count > 0)
    {
        <!-- Period Summary -->
        <div class="card mt-3 border-success">
            <div class="card-header bg-success bg-opacity-10"><strong>üìã Period Summary</strong></div>
            <div class="card-body py-2">
                <div class="row g-2 text-center">
                    <div class="col-6 col-md-2">
                        <div class="border rounded p-2">
                            <div class="small text-muted">Data Points</div>
                            <div class="fw-bold">@timeSeriesData.Count</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="border rounded p-2">
                            <div class="small text-muted">Avg COP</div>
                            <div class="fw-bold text-success">@Avg(timeSeriesData.Select(d => d.Cop))</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="border rounded p-2">
                            <div class="small text-muted">Total Energy In</div>
                            <div class="fw-bold text-primary">@Sum(timeSeriesData.Select(d => d.EnergyInputVal)) kWh</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="border rounded p-2">
                            <div class="small text-muted">Total Energy Out</div>
                            <div class="fw-bold text-danger">@Sum(timeSeriesData.Select(d => d.EnergyOutputVal)) kWh</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="border rounded p-2">
                            <div class="small text-muted">Avg Outdoor Temp</div>
                            <div class="fw-bold text-warning">@Avg(timeSeriesData.Select(d => d.OutdoorTempVal)) ¬∞C</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-2">
                        <div class="border rounded p-2">
                            <div class="small text-muted">Grouping</div>
                            <div class="fw-bold">@(string.IsNullOrEmpty(grouping) ? "Auto" : grouping)</div>
                            <div class="small text-muted">@GroupingDescription</div>
                        </div>
                    </div>
                </div>
                <div class="mt-2 small text-muted">
                    Period: <strong>@fromDate.ToString("g")</strong> ‚Üí <strong>@toDate.ToString("g")</strong>
                    &nbsp;¬∑&nbsp; @GroupingGranularityNote
                </div>
            </div>
        </div>
        <!-- COP Trend Chart -->
        <div class="card mt-4">
            <div class="card-header">COP Trend</div>
            <div class="card-body">
                <RadzenChart Style="height: 300px;">
                    <RadzenLineSeries Data="@timeSeriesData" CategoryProperty="EndAt" ValueProperty="Cop"
                                     Title="COP" Stroke="rgb(40,167,69)" StrokeWidth="2" />
                    <RadzenCategoryAxis FormatString="{0:MMM dd HH:mm}" />
                    <RadzenValueAxis Min="0">
                        <RadzenGridLines Visible="true" />
                    </RadzenValueAxis>
                    <RadzenLegend Visible="true" Position="LegendPosition.Bottom" />
                </RadzenChart>
            </div>
        </div>

        <!-- Energy Flow Chart -->
        <div class="card mt-3">
            <div class="card-header">Energy Flow</div>
            <div class="card-body">
                <RadzenChart Style="height: 300px;">
                    <RadzenColumnSeries Data="@timeSeriesData" CategoryProperty="EndAt" ValueProperty="EnergyOutputVal"
                                        Title="Energy Output (kWh)" Fill="rgb(220,53,69)" />
                    <RadzenColumnSeries Data="@timeSeriesData" CategoryProperty="EndAt" ValueProperty="EnergyInputVal"
                                        Title="Energy Input (kWh)" Fill="rgb(0,123,255)" />
                    <RadzenCategoryAxis FormatString="{0:MMM dd}" />
                    <RadzenValueAxis Min="0">
                        <RadzenGridLines Visible="true" />
                    </RadzenValueAxis>
                    <RadzenLegend Visible="true" Position="LegendPosition.Bottom" />
                </RadzenChart>
            </div>
        </div>

        <!-- Outdoor Temperature Chart -->
        <div class="card mt-3">
            <div class="card-header">Outdoor Temperature</div>
            <div class="card-body">
                <RadzenChart Style="height: 250px;">
                    <RadzenLineSeries Data="@timeSeriesData" CategoryProperty="EndAt" ValueProperty="OutdoorTempVal"
                                     Title="Outdoor Temp (¬∞C)" Stroke="rgb(255,193,7)" StrokeWidth="2" />
                    <RadzenCategoryAxis FormatString="{0:MMM dd}" />
                    <RadzenValueAxis>
                        <RadzenGridLines Visible="true" />
                    </RadzenValueAxis>
                    <RadzenLegend Visible="true" Position="LegendPosition.Bottom" />
                </RadzenChart>
            </div>
        </div>

        <!-- Statistics Table -->
        <div class="card mt-3">
            <div class="card-header">Period Statistics</div>
            <div class="card-body">
                <table class="table table-bordered table-sm mb-0">
                    <tbody>
                        <tr>
                            <td><strong>Data Points</strong></td><td>@timeSeriesData.Count</td>
                            <td><strong>Period</strong></td><td>@fromDate.ToString("g") ‚Äì @toDate.ToString("g")</td>
                        </tr>
                        <tr>
                            <td><strong>Avg COP</strong></td><td>@Avg(timeSeriesData.Select(d => d.Cop))</td>
                            <td><strong>Max COP</strong></td><td>@Max(timeSeriesData.Select(d => d.Cop))</td>
                        </tr>
                        <tr>
                            <td><strong>Total Energy In</strong></td><td>@Sum(timeSeriesData.Select(d => d.EnergyInputVal)) kWh</td>
                            <td><strong>Total Energy Out</strong></td><td>@Sum(timeSeriesData.Select(d => d.EnergyOutputVal)) kWh</td>
                        </tr>
                        <tr>
                            <td><strong>Avg Outdoor Temp</strong></td><td>@Avg(timeSeriesData.Select(d => d.OutdoorTempVal)) ¬∞C</td>
                            <td><strong>Min Outdoor Temp</strong></td><td>@Min(timeSeriesData.Select(d => d.OutdoorTempVal)) ¬∞C</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Raw Data Table -->
        <details class="mt-3">
            <summary class="btn btn-outline-secondary btn-sm">Show Raw Data (@timeSeriesData.Count rows)</summary>
            <table class="table table-striped table-sm mt-2">
                <thead>
                    <tr><th>Period End</th><th>COP</th><th>Energy Out (kWh)</th><th>Energy In (kWh)</th><th>Outdoor (¬∞C)</th></tr>
                </thead>
                <tbody>
                    @foreach (var pt in timeSeriesData)
                    {
                        <tr>
                            <td>@pt.EndAt.ToString("g")</td>
                            <td>@pt.Cop.ToString("F2")</td>
                            <td>@pt.EnergyOutputVal.ToString("F2")</td>
                            <td>@pt.EnergyInputVal.ToString("F2")</td>
                            <td>@pt.OutdoorTempVal.ToString("F1")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </details>
    }
}

@code {
    private string accountNumber = "";
    private string? euid;
    private bool isLoading;
    private string? errorMessage;
    private string? statusMessage;
    private string? rangeValidationMessage;

    private DateTime fromDate = DateTime.UtcNow.AddDays(-7);
    private DateTime toDate = DateTime.UtcNow;
    private string grouping = "";

    private List<ChartPoint> timeSeriesData = [];

    /// <summary>View-model for Radzen charts ‚Äî all numeric properties so charts can bind.</summary>
    private sealed class ChartPoint
    {
        public DateTime EndAt { get; set; }
        public double Cop { get; set; }
        public double EnergyOutputVal { get; set; }
        public double EnergyInputVal { get; set; }
        public double OutdoorTempVal { get; set; }
    }

    private string GroupingDescription => grouping?.ToUpperInvariant() switch
    {
        "LIVE"  => "min-by-min",
        "DAY"   => "hour-by-hour",
        "WEEK"  => "day-by-day",
        "MONTH" => "day-by-day",
        "YEAR"  => "day-by-day",
        _       => "auto"
    };

    private string GroupingGranularityNote => grouping?.ToUpperInvariant() switch
    {
        "LIVE"  => "Each data point represents one minute of data for the selected hour.",
        "DAY"   => "Each data point represents one hour of data.",
        "WEEK"  => "Each data point represents one day of data.",
        "MONTH" => "Each data point represents one day of data.",
        "YEAR"  => "Each data point represents one day of data.",
        _       => "Grouping is chosen automatically based on the selected date range."
    };

    private string? ValidateDateRange()
    {
        var span = toDate - fromDate;
        return grouping?.ToUpperInvariant() switch
        {
            "LIVE"  when span > TimeSpan.FromHours(1)       => "Live grouping: maximum range is 1 hour (minute-by-minute data).",
            "DAY"   when span > TimeSpan.FromDays(2)        => "Day grouping: maximum range is 2 days (hour-by-hour data).",
            "WEEK"  when span > TimeSpan.FromDays(14)       => "Week grouping: maximum range is 14 days (day-by-day data).",
            "MONTH" when span > TimeSpan.FromDays(60)       => "Month grouping: maximum range is 60 days (day-by-day data).",
            "YEAR"  when span > TimeSpan.FromDays(13 * 31)  => "Year grouping: maximum range is 13 months (day-by-day data).",
            _ => null
        };
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var settings = await Api.GetSettingsAsync();
            var s = settings.FirstOrDefault();
            if (s != null) accountNumber = s.AccountNumber;

            var devices = await Api.GetDevicesAsync();
            if (devices.Length > 0)
            {
                accountNumber = devices[0].AccountNumber;
                euid = devices[0].Euid;
            }
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private void SetRange(int days)
    {
        toDate = DateTime.UtcNow;
        fromDate = DateTime.UtcNow.AddDays(-days);
        rangeValidationMessage = ValidateDateRange();
    }

    private async Task LoadTimeSeries()
    {
        if (string.IsNullOrEmpty(accountNumber) || string.IsNullOrEmpty(euid))
        { statusMessage = "‚ùå Account or EUID not set."; return; }

        rangeValidationMessage = ValidateDateRange();
        if (rangeValidationMessage is not null)
        { statusMessage = $"‚ùå {rangeValidationMessage}"; return; }

        isLoading = true;
        statusMessage = "Loading...";
        timeSeriesData.Clear();

        try
        {
            var raw = await Api.GetTimeSeriesRawAsync(accountNumber, euid, fromDate, toDate,
                string.IsNullOrEmpty(grouping) ? null : grouping);

            var doc = System.Text.Json.JsonDocument.Parse(raw);
            var root = doc.RootElement.GetProperty("data");

            if (root.TryGetProperty("octoHeatPumpTimeSeriesPerformance", out var seriesEl)
                && seriesEl.ValueKind == System.Text.Json.JsonValueKind.Array)
            {
                foreach (var item in seriesEl.EnumerateArray())
                {
                    var pt = new ChartPoint();

                    if (item.TryGetProperty("endAt", out var endAt) && DateTime.TryParse(endAt.GetString(), out var dt))
                        pt.EndAt = dt;

                    var energyOut = GetNestedValue(item, "energyOutput");
                    var energyIn = GetNestedValue(item, "energyInput");
                    var outdoor = GetNestedValue(item, "outdoorTemperature");

                    pt.EnergyOutputVal = energyOut ?? 0;
                    pt.EnergyInputVal = energyIn ?? 0;
                    pt.OutdoorTempVal = outdoor ?? 0;
                    pt.Cop = energyIn > 0 ? (energyOut ?? 0) / energyIn.Value : 0;

                    timeSeriesData.Add(pt);
                }

                statusMessage = $"‚úÖ Loaded {timeSeriesData.Count} data points";
            }
            else if (root.TryGetProperty("octoHeatPumpTimeSeriesPerformance", out var nullEl)
                     && nullEl.ValueKind == System.Text.Json.JsonValueKind.Null)
            {
                statusMessage = "‚ùå No data for this date range. Try a different period.";
            }
            else
            {
                statusMessage = "‚ùå Unexpected response format from the API.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"‚ùå {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private static double? GetNestedValue(System.Text.Json.JsonElement item, string property)
    {
        if (item.TryGetProperty(property, out var el) && el.TryGetProperty("value", out var val))
        {
            var str = val.GetString();
            if (double.TryParse(str, System.Globalization.NumberStyles.Any,
                System.Globalization.CultureInfo.InvariantCulture, out var result))
                return result;
        }
        return null;
    }

    private static string Avg(IEnumerable<double> values)
    {
        var list = values.Where(v => v != 0).ToList();
        return list.Count > 0 ? list.Average().ToString("F2") : "‚Äî";
    }

    private static string Max(IEnumerable<double> values)
    {
        var list = values.Where(v => v != 0).ToList();
        return list.Count > 0 ? list.Max().ToString("F2") : "‚Äî";
    }

    private static string Min(IEnumerable<double> values)
    {
        var list = values.Where(v => v != 0).ToList();
        return list.Count > 0 ? list.Min().ToString("F1") : "‚Äî";
    }

    private static string Sum(IEnumerable<double> values)
    {
        return values.Sum().ToString("F2");
    }
}

