@page "/heatpump/comfort"
@inject HeatPumpApiClient Api
@rendermode InteractiveServer

<PageTitle>Heat Pump ‚Äì Home Comfort</PageTitle>

<h1>üè† Home Comfort</h1>
<p class="text-muted">Temperature and humidity readings from your Cosy Pods and zone statuses.</p>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isLoading && summary == null)
{
    <p><em>Loading sensor data...</em></p>
}
else if (summary != null)
{
    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-success btn-sm" @onclick="Refresh" disabled="@isLoading">‚ü≥ Refresh</button>
    </div>

    <!-- Sensor Cards (Cosy Pods + ADC sensors) -->
    <h4>Sensors</h4>
    @if (summary.ControllerStatus?.Sensors?.Count > 0)
    {
        <div class="row g-3">
            @foreach (var sensor in summary.ControllerStatus.Sensors)
            {
                var isOnline = sensor.Connectivity?.Online == true;
                var borderClass = isOnline ? "border-success" : "border-secondary";
                var hasTemp = sensor.Telemetry?.TemperatureInCelsius.HasValue == true;
                var hasHumidity = sensor.Telemetry?.HumidityPercentage.HasValue == true;

                <div class="col-md-4 col-lg-3">
                    <div class="card @borderClass h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>@(sensor.Code ?? "Unknown")</strong>
                            <span class="badge @(isOnline ? "bg-success" : "bg-secondary")">@(isOnline ? "Online" : "Offline")</span>
                        </div>
                        <div class="card-body text-center">
                            @if (hasTemp)
                            {
                                <div class="mb-2">
                                    <span class="fs-1">@(sensor.Telemetry!.TemperatureInCelsius!.Value.ToString("F1"))</span>
                                    <span class="text-muted">¬∞C</span>
                                </div>
                            }
                            @if (hasHumidity)
                            {
                                <div>
                                    <span class="fs-4">@(sensor.Telemetry!.HumidityPercentage!.Value.ToString("F0"))</span>
                                    <span class="text-muted">% humidity</span>
                                </div>
                            }
                            @if (!hasTemp && !hasHumidity)
                            {
                                <p class="text-muted">No telemetry data</p>
                            }
                        </div>
                        <div class="card-footer text-muted small">
                            @(sensor.Telemetry?.RetrievedAt ?? "‚Äî")
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">No sensors returned from the controller.</div>
    }

    <!-- Zone Status -->
    <h4 class="mt-5">Zone Status</h4>
    @if (summary.ControllerStatus?.Zones?.Count > 0)
    {
        <div class="row g-3">
            @foreach (var zone in summary.ControllerStatus.Zones)
            {
                var isHeating = zone.Telemetry?.HeatDemand == true;
                var borderClass = isHeating ? "border-danger" : "border-info";

                <div class="col-md-6">
                    <div class="card @borderClass h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <strong>@(zone.Zone ?? "Unknown Zone")</strong>
                            @if (isHeating)
                            {
                                <span class="badge bg-danger">üî• Heating</span>
                            }
                            else
                            {
                                <span class="badge bg-info">Idle</span>
                            }
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <h6 class="text-muted">Mode</h6>
                                    <h5>@(zone.Telemetry?.Mode ?? "‚Äî")</h5>
                                </div>
                                <div class="col-4">
                                    <h6 class="text-muted">Setpoint</h6>
                                    <h5>@(zone.Telemetry?.SetpointInCelsius?.ToString("F1") ?? "‚Äî") ¬∞C</h5>
                                </div>
                                <div class="col-4">
                                    <h6 class="text-muted">Relay</h6>
                                    <h5>@(zone.Telemetry?.RelaySwitchedOn == true ? "ON" : "OFF")</h5>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer text-muted small">
                            @(zone.Telemetry?.RetrievedAt ?? "‚Äî")
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">No zone status returned.</div>
    }

    <!-- Zone Configuration (from controller config) -->
    <h4 class="mt-5">Zone Configuration</h4>
    @if (summary.ControllerConfiguration?.Zones?.Count > 0)
    {
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Enabled</th>
                    <th>Mode</th>
                    <th>Setpoint</th>
                    <th>Action</th>
                    <th>Call for Heat</th>
                    <th>Emergency</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var z in summary.ControllerConfiguration.Zones)
                {
                    var c = z.Configuration;
                    <tr>
                        <td>@(c?.DisplayName ?? "‚Äî")</td>
                        <td>@(c?.ZoneType ?? "‚Äî")</td>
                        <td>@(c?.Enabled == true ? "‚úÖ" : "‚ùå")</td>
                        <td>@(c?.CurrentOperation?.Mode ?? "‚Äî")</td>
                        <td>@(c?.CurrentOperation?.SetpointInCelsius?.ToString("F1") ?? "‚Äî") ¬∞C</td>
                        <td>@(c?.CurrentOperation?.Action ?? "‚Äî")</td>
                        <td>@(c?.CallForHeat == true ? "Yes" : "No")</td>
                        <td>@(c?.Emergency == true ? "‚ö†Ô∏è Yes" : "No")</td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- Sensor Configuration Detail -->
    <h4 class="mt-5">Sensor Configuration</h4>
    @if (AllSensors.Count > 0)
    {
        <table class="table table-striped table-sm">
            <thead>
                <tr><th>Code</th><th>Name</th><th>Type</th><th>Enabled</th><th>Firmware</th><th>Boost</th></tr>
            </thead>
            <tbody>
                @foreach (var s in AllSensors)
                {
                    <tr>
                        <td>@(s.Code ?? "‚Äî")</td>
                        <td>@(s.DisplayName ?? "‚Äî")</td>
                        <td>@(s.Type ?? "‚Äî")</td>
                        <td>@(s.Enabled == true ? "‚úÖ" : "‚ùå")</td>
                        <td>@(s.FirmwareVersion ?? "‚Äî")</td>
                        <td>@(s.BoostEnabled == true ? "Yes" : "‚Äî")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p class="text-muted">No sensor configuration data available.</p>
    }
}

@code {
    private string? deviceId;
    private bool isLoading;
    private string? errorMessage;
    private HeatPumpSummaryDto? summary;

    private List<HeatPumpSensorConfigurationDto> AllSensors =>
        summary?.ControllerConfiguration?.Zones?
            .Where(z => z.Configuration?.Sensors != null)
            .SelectMany(z => z.Configuration!.Sensors)
            .ToList() ?? [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var devices = await Api.GetDevicesAsync();
            if (devices.Length > 0) { deviceId = devices[0].DeviceId; await Refresh(); }
            else errorMessage = "No device set up. Go to the Dashboard to run setup.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task Refresh()
    {
        if (deviceId == null) return;
        isLoading = true;
        try { summary = await Api.GetSummaryAsync(deviceId); }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }
}

