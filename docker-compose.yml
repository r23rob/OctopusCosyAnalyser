# docker-compose.yml â€“ run OctopusCosyAnalyser on any Docker host (including a Raspberry Pi)
#
# Quick start:
#   1. Copy .env.example to .env and fill in your values
#   2. docker compose pull          # pull pre-built images from ghcr.io
#   3. docker compose up -d         # start everything in the background
#
# The web UI is available at http://<host-ip>:${WEB_PORT:-8080}

services:

  postgres:
    image: postgres:17-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: cosydb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in your .env file}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d cosydb"]
      interval: 10s
      timeout: 5s
      retries: 5

  apiservice:
    image: ghcr.io/r23rob/octopuscosyanalyser/apiservice:latest
    restart: unless-stopped
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__cosydb: >-
        Host=postgres;Port=5432;Database=cosydb;Username=postgres;Password=${POSTGRES_PASSWORD}
    depends_on:
      postgres:
        condition: service_healthy

  webfrontend:
    image: ghcr.io/r23rob/octopuscosyanalyser/webfrontend:latest
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-8080}:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      # Tells .NET service discovery how to reach the API service inside Docker
      services__apiservice__http__0: http://apiservice:8080
    depends_on:
      - apiservice

volumes:
  postgres-data:
